---
title: 'Scope 1: Fisheries Context'
author: "Camila Vargas e Ignacia Rivera"
date: "August 16, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(magrittr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
```

## Introduction

The goal of this scope is to combine the data and information gathered from different sources to identify the top domestic fisheries contributing to the landings and national economy of Chile. The following script provides all the methods, information and data that is use to persue this goal. The script is separated in sections that refer to two differen obectives, the first assesing the contribution of different species to volume of landings and the second assesing value of landings. Sections are also based on the sources of data being used. 

## Main sources of information

We will identify the main domestic fisheries regarding volume and value using three different main data sources SERNAPESCA, Sea around us project and FAO estimates. 

## Requested outputs

1) A list of the top 10 domestic marine fisheries in terms of landed volume
2) A list of the top 10 domestic marine fisheries in terms of economic value
3) A clean database use to generate (1)
4) A database use to generate (4)

## Resolution

Where possible, these data should also be broken down by gear type.

## 1) Top domestic marine, capture fisheries based on landed volume

### Using data from SERNAPESCA

```{r importing clean landings SERNAPESCA per species, subsector, month and region}

landings_reg<- read_csv(here("clean_databases/landings_SERNAPESCA.csv")) %>% 
  filter(region != "national") %>% 
  mutate( tons = as.numeric(tons))

```

Arranging data fram to visulize most immportant fsheries per landing per region based on landings per region and year from 2014 to 2017

```{r}

##General
landing_reg_general <- landings_reg %>%
  arrange(year, region, desc(tons))


##Artisanal

landing_reg_artisanal <- landings_reg %>%
  filter(subsector == "artisanal") %>% 
  arrange(year, region, desc(tons))

##Industrial

landing_reg_industrial <- landings_reg %>%
  filter(subsector == "industrial") %>% 
  arrange(year, region, desc(tons))
  
## frabric_vessels (ADD THEM TO INDUSTRIAL???)

landing_reg_fv <- landings_reg %>%
  filter(subsector == "fabric_vessel") %>% 
  arrange(year, region, desc(tons))

##WHAT TO DO DO WITH INTERNATIONAL WATERS?


```


Adding landings across all reagions to determine the main fisheries nationwise


```{r}
##Add landings per specie per year across all reagions

total_landings_national <- landings_reg %>% 
  group_by(year, species) %>% 
  summarise(tons_total = sum(tons, na.rm = T)) %>% 
  arrange(year, desc(tons_total)) %>% 
  data.frame()

total_landings_subsector <- landings_reg %>% 
  group_by(subsector, year, species) %>% 
  summarise(tons_total = sum(tons, na.rm = T)) %>% 
  arrange(year, desc(tons_total)) %>% 
  data.frame()

total_landings_artisanal <- landings_reg %>% 
  filter(subsector== "artisanal") %>% 
  group_by(year, species) %>% 
  summarise(tons_total_art = sum(tons, na.rm = T)) %>% 
  arrange(year, desc(tons_total_art)) %>% 
  data.frame()

total_landings_industrial <-  landings_reg %>% 
  filter(subsector %in% c("industrial", "fabric_vessel")) %>% 
  group_by(year, species) %>% 
  summarise(tons_total_ind = sum(tons, na.rm = T)) %>% 
  arrange(year, desc(tons_total_ind)) %>% 
  data.frame()


total_landings_nat_subsector <-  total_landings_national %>% 
  left_join(total_landings_artisanal, by= c("year", "species")) %>% 
  left_join(total_landings_industrial, by= c("year", "species"))


```


10 main fisheries per year

```{r}

##Filtering the 10 main fishereis according to total landings per year
top10_landings_per_year <- total_landings_nat_subsector %>% 
  group_by(year) %>% 
  top_n(10, tons_total) %>% 
  data.frame()
  
write.csv(top10_landings_per_year,  here("clean_databases/scope1/top10_landings_per_year.csv"), row.names=F)

```


Ploting the main fisheries according to landings from 2014 to 2017 and the contribution of each subsector. 
For plotting purpose only the 3 main fisheries according to landings are selected

```{r}

##Wrangling for plotting
top3_landings_per_year <- total_landings_nat_subsector %>% 
  group_by(year) %>% 
  top_n(3, tons_total) %>% 
  data.frame()

top3_landings <- top3_landings_per_year %>% 
  select(-tons_total) %>% 
  gather(subsector, count, tons_total_art:tons_total_ind)

  ##not doing exactoly what I want
  ggplot(., aes(x=species, y=count, fill=forcats::fct_rev(subsector))) +
   geom_bar(stat="identity")
  
##see the following link for plotting options
  #https://stackoverflow.com/questions/30023610/how-to-plot-2-categorical-variables-on-x-axis-and-two-continuous-variables-as-f

##ejemplo
df %>% 
   select(-total) %>% 
   gather(type, count, burglaries:robberies) %>% 
   ggplot(., aes(x=year, y=count, fill=forcats::fct_rev(type))) +
   geom_bar(stat="identity")




```






