---
title: "Food model"
author: "Camila Vargas e Ignacia Rivera"
date: "December 12, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(here)
library(magrittr)
library(tidyr)
library(reshape2)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(readxl)
library(cowplot)
library(kableExtra)
library(readr)
library(stringr)
library(purrr)
library(naniar)
library(wesanderson)

ggtheme_plot <- function() {
  theme(
    plot.title = element_text(size = rel(1), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    strip.background = element_blank(),
    # strip.text       = element_text(size = base_size, face = "italic"),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 10,
                               angle = 0,
                               face = "plain"),
    axis.text.y = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.key = element_rect(colour = NA, fill = NA),
    legend.position  = "top",
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 14),
    strip.text.x = element_text(size = 18, colour = "darkgrey")
  )
}

## Species index

sp_index <- read_csv(here("clean_databases/sp_index.csv"))
```

## Landings

Landings come either from industrial, which includes fabric vessels ($l_i$), or artisanal vessels ($l_a$).

## Types of product use

Landings can either be sold as fresh products for huamn consumption ($F_{HC}$) go to processing facilities where they will be transformed in products for human consumption ($P_{HC}$) or products for other uses ($P_{NHC}$). In both processes there are discards ($D_{HC}, D_{NHC}$) that can be represented as the differences between what entered the processing facility as raw material ($D_{HC} = R_{HC} - P_{HC}$, $D_{NHC} = R_{NHC} - P_{NHC}$ ). 

```{r Landings, echo = FALSE, message = FALSE, warning=FALSE}

## species match
chl_to_sc <- sp_index %>% 
  select(chl_name, sc_name) %>% 
  unique()

# Landings artisanal
l.a <- read_csv(here("clean_databases/landings_SERNAPESCA.csv")) %>% 
  filter(region != 'national', subsector == 'artisanal') %>% 
  select(-international_waters, -month) %>% 
  rename(chl_name = species) %>% 
  left_join(chl_to_sc) %>% 
  select(-chl_name, -subsector)

l.a$tons[is.na(l.a$tons)] <- 0  

# Landings industrial

l.i <- read_csv(here("clean_databases/landings_SERNAPESCA.csv")) %>% 
    mutate(subsector = ifelse(subsector == 'fabric_vessel', 'industrial', subsector)) %>% 
    filter(region != 'national', subsector == 'industrial') %>% 
    select(-international_waters, -month)%>% 
    rename(chl_name = species) %>% 
    left_join(chl_to_sc) %>% 
    select(-chl_name, -subsector)

l.i$tons[is.na(l.i$tons)] <- 0

```

```{r Lines of production, echo = FALSE, message=FALSE, warning=FALSE}

### Data for Products for Non Human consumption (R_NHC)

## 2013

FE_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "FEespreg", range = "A6:Q122") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fresh', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

congelado_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "CONGespreg", range = "A6:Q179") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'frozen', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

saladohumedo_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "SALHUMesoreg", range = "A6:Q11") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty wet', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

ahumado_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "AHUMespreg", range = "A6:Q12") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'smoked', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

conserva_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "CONSespreg", range = "A6:Q67") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'canned', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

aceite_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "Aceitereg", range = "A6:Q31") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'oil', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

agar_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "Agarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'agar', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

algaseca_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "ALGASECAespreg", range = "A6:Q32") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dry algae', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

deshidratado_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "DESHespreg", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dehydrate', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

carragenina_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "Carrageninareg", range = "A6:Q12") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'carragenina', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

colagar_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "Colagarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'colagar', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

harina_2013 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "Harinareg", range = "A6:Q44") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fish meal', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

## importing 2014

FE_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "FE_region", range = "A6:Q118") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fresh', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

congelado_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Cong_region", range = "A6:Q184") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'frozen', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

saladoseco_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Salseco_region", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty dry', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

saladohumedo_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Salhum_region", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty wet', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

ahumado_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Ahumado_region", range = "A6:Q12") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'smoked', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

conserva_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Conserva_region", range = "A6:Q59") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'canned', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

harina_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Harinareg", range = "A6:Q54") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fish meal', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

aceite_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Aceitereg", range = "A6:Q42") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'oil', year = 2014, tons = ifelse(tons =="-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

agar_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Agarreg", range = "A6:Q10") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'agar', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

algaseca_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Algaseca_region", range = "A6:Q28") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dry algae', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

colagar_2014 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2014.xlsx"), sheet = "Colagarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'colagar', year = 2014, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

## importing 2015

FE_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "FE_REGION", range = "A6:Q123") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fresh', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

congelado_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2013.xlsx"), sheet = "CONGespreg", range = "A6:Q182") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'frozen', year = 2013, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

saladoseco_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "SALADO SECO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty dry', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

ahumado_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "AHUMADO_REGION", range = "A6:Q10") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'smoked', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

conserva_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "CONSERVA_REGION", range = "A6:Q51") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'canned', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

harina_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "Harinareg", range = "A6:Q46") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fish meal', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

agar_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "Agarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'agar', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

algaseca_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "ALGA SECA_REGION", range = "A6:Q30") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dry algae', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

deshidratado_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "DESHIDRATADO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dehydrate', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

alginato_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "Alginatoreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'alginato', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

carragenina_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "Carrageninareg", range = "A6:Q12") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'carragenina', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

colagar_2015 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2015.xlsx"), sheet = "Colagarreg", range = "A6:Q10") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'colagar', year = 2015, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

## importing 2016

FE_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "FE_REGION", range = "A6:Q154") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fresh', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

congelado_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "CONG_REGION", range = "A6:Q174") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'frozen', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

saladoseco_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "SALADO SECO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty dry', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

saladohumedo_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "SALADO HUMEDO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty wet', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

ahumado_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "AHUMADO_REGION", range = "A6:Q10") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'smoked', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

conserva_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "CONSERVA_REGION", range = "A6:Q59") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'canned', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

harina_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "Harinareg", range = "A6:Q44") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fish meal', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
   rename(chl_name =  ESPECIE)

aceite_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "Aceitereg", range = "A6:P31") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:16)%>% 
  mutate (product = 'oil', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

agar_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "Agarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'agar', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

algaseca_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "ALGA SECA_REGION", range = "A6:P34") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:16)%>% 
  mutate (product = 'dry algae', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

deshidratado_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "DESHIDRATADO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dehydrate', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

carragenina_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "Carrageninareg", range = "A6:Q12") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'carragenina', year = 2016, tons = ifelse(tons =="-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

colagar_2016 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2016.xlsx"), sheet = "Colagarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'colagar', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

## importing 2017

FE_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "FE_REGION", range = "A6:Q149") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fresh', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

congelado_2017<- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "CONG_REGION", range = "A6:Q172") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'frozen', year = 2016, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

saladoseco_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "SALADO SECO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty dry', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

saladohumedo_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "SALADO HUMEDO_REGION", range = "A6:Q8") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'salty wet', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

ahumado_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "AHUMADO_REGION", range = "A6:Q10") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'smoked', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

conserva_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "CONSERVA_REGION", range = "A6:Q53") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'canned', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

harina_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "Harinareg", range = "A6:Q46") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'fish meal', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

aceite_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "Aceitereg", range = "A6:Q34") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'oil', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

agar_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "Agarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>%
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'agar', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

algaseca_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "ALGA SECA_REGION", range = "A6:Q36") %>%
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'dry algae', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>%
  rename(chl_name =  ESPECIE)

carragenina_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "Carrageninareg", range = "A6:Q14") %>% 
  filter(ESPECIE != 'NA') %>%
  rename(m_p= X__1) %>% 
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'carragenina', year = 2017, tons = ifelse(tons =="-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

colagar_2017 <- read_excel(here("information/raw_databases/SERNAPESCA/products/products_per_species_region_month_2017.xlsx"), sheet = "Colagarreg", range = "A6:Q8") %>% 
  filter(ESPECIE != 'NA') %>% 
  rename(m_p= X__1) %>%
  gather(key = region, value = tons, 3:17)%>% 
  mutate (product = 'colagar', year = 2017, tons = ifelse(tons == "-", 0, tons)) %>% 
  rename(chl_name =  ESPECIE)

# Combining p_nhc

HC <- c('fish meal', 'fresh', 'frozen', 'salty dry', 'salty wet', 'smoked', 'canned', 'dehydrate')

processing <- dplyr::bind_rows(aceite_2013, aceite_2014, aceite_2016, agar_2013, agar_2014, agar_2015, agar_2016, alginato_2015, carragenina_2013, carragenina_2015, carragenina_2016, colagar_2013, colagar_2014, colagar_2015, colagar_2016, harina_2013, harina_2014, harina_2015, harina_2016, harina_2017, algaseca_2013 ,algaseca_2014 ,algaseca_2015 ,algaseca_2016 ,algaseca_2017, FE_2013, FE_2014, FE_2015, FE_2016, FE_2017, congelado_2013, congelado_2014, congelado_2015,congelado_2016 ,congelado_2017 ,saladoseco_2014 ,saladoseco_2015 ,saladoseco_2016 ,saladoseco_2017 ,saladohumedo_2013, saladohumedo_2014 ,saladohumedo_2016 ,saladohumedo_2017, ahumado_2013 ,ahumado_2014,ahumado_2015 ,ahumado_2016 ,ahumado_2017,conserva_2013 , conserva_2014, conserva_2015 ,conserva_2016 ,conserva_2017 ,deshidratado_2013 , deshidratado_2015 ,deshidratado_2016) %>% 
mutate(use = ifelse(product %in% HC, 'HC', 'NHC'), tons = as.numeric(tons))

```

```{r Landing playa, echo= FALSE, message=FALSE, warning=FALSE}

## Raw material in processing plants with scientific name per region and year

processing_minus_ind <- processing %>% 
  filter(m_p== 'M', tons !=0) %>% 
  select(-use, -m_p, -product) %>% 
  left_join(chl_to_sc) %>% 
  select(-chl_name) %>% 
  left_join(l.i, by= c('year', 'region', 'sc_name')) %>% 
  mutate(tons_raw = as.numeric(tons.x), tons_ind = as.numeric(tons.y)) %>% 
  select(-tons.x, -tons.y)
  
processing_minus_ind$tons_ind[is.na(processing_minus_ind$tons_ind)] <- 0

processing_minus_ind <- processing_minus_ind %>% 
  mutate(no_ind_raw = tons_raw - tons_ind) 


```

